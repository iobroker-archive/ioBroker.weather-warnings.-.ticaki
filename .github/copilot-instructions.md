# ioBroker Weather Warnings Adapter

This is an ioBroker adapter for receiving and processing weather warnings from various services (DWD, ZAMG, UWZ), written in TypeScript. The adapter fetches weather warnings, processes them, creates ioBroker states, and can send notifications via multiple services (Telegram, WhatsApp, Pushover, Email, Alexa, Say-It).

Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Working Effectively

### Bootstrap and Build Commands
- **Install dependencies**: `npm install` -- takes ~20 seconds to install 523 packages. Always run this first.
- **Build the adapter**: `npm run build` -- takes ~3 seconds. NEVER CANCEL. Uses build-adapter ts + TypeScript type checking.
- **Type checking only**: `npm run check` -- takes ~2 seconds. Runs tsc --noEmit for type validation.

### Testing Commands  
- **Package validation**: `npm run test:package` -- takes ~0.4 seconds. Runs 40 validation tests for package.json and io-package.json structure.
- **Integration tests**: `npm run test:integration` -- takes ~4 minutes. NEVER CANCEL. Set timeout to 300+ seconds. Runs full adapter lifecycle including Redis/ioBroker setup.
- **Unit tests**: `npm run test:ts` -- CURRENTLY BROKEN due to chai version conflicts in test setup. Use integration tests instead.
- **All tests**: `npm run test` -- runs test:ts + test:package. Currently fails due to unit test issues.

### Code Quality Commands
- **Linting**: `npm run lint` -- takes ~6 seconds. Uses ESLint with @iobroker/eslint-config. Always run before committing.
- **Formatting**: `npx prettier --check src/` to check, `npx prettier --write src/` to fix formatting issues.
- **Translation update**: `npm run translate` -- takes ~1 second. Updates i18n translations for admin UI.

### Development Workflow
Always run this sequence before committing changes:
1. `npm run build` -- NEVER CANCEL, takes ~3 seconds
2. `npm run lint` -- takes ~6 seconds  
3. `npm run test:package` -- takes ~0.4 seconds
4. `npm run test:integration` -- NEVER CANCEL, takes ~4 minutes

## Validation

### Manual Testing Scenarios
- **ALWAYS** run the complete integration test suite after making changes with `npm run test:integration`. This tests the full adapter lifecycle.
- **Build validation**: Always verify `npm run build` completes successfully and produces clean output in `build/` directory.
- **Configuration validation**: If changing admin configuration, test that the adapter starts correctly and processes test data.
- You cannot run the adapter standalone outside of ioBroker environment, so rely on integration tests.

### Common Validation Steps
- Always run `npm run lint` before committing -- the CI (.github/workflows/test-and-release.yml) will fail otherwise.
- Always run `npm run check` for TypeScript type checking.
- If modifying admin UI or translations, run `npm run translate` to update i18n files.
- Integration tests will fail if there are network connectivity issues to weather services, but adapter core functionality is still validated.

## Project Structure and Navigation

### Key Directories
- `src/` -- TypeScript source code for the adapter
  - `src/main.ts` -- Main adapter entry point
  - `src/lib/` -- Core library modules (provider, notifications, etc.)
  - `src/main.test.ts` -- Unit test file (currently has setup issues)
- `build/` -- Compiled JavaScript output (generated by build command)
- `admin/` -- Admin UI configuration and assets
  - `admin/jsonConfig.json` -- Admin UI configuration 
  - `admin/i18n/` -- Translation files for admin UI
- `test/` -- Test files and configuration
  - `test/integration.js` -- Integration tests that actually work
  - `test/package.js` -- Package validation tests
- `img/` -- Icons and images for the adapter

### Key Configuration Files
- `package.json` -- NPM package configuration, scripts, and dependencies
- `io-package.json` -- ioBroker adapter metadata and configuration
- `tsconfig.json` -- TypeScript configuration for development
- `tsconfig.build.json` -- TypeScript configuration for building
- `eslint.config.mjs` -- ESLint configuration
- `prettier.config.mjs` -- Prettier formatting configuration

### GitHub Actions
- `.github/workflows/test-and-release.yml` -- CI/CD pipeline that runs linting, type checking, and tests on Node.js 20.x/22.x/24.x across Ubuntu/Windows/macOS

## Known Issues and Workarounds

### Unit Test Setup Issue
- `npm run test:ts` fails due to chai version conflicts between @iobroker/testing dependencies
- **Workaround**: Use `npm run test:integration` instead, which provides comprehensive adapter testing
- **DO NOT** attempt to fix by modifying chai dependencies -- this breaks the @iobroker/testing framework

### Security Vulnerabilities
- Repository has 2 dependencies with security vulnerabilities (1 low, 1 critical in form-data)
- These are in development dependencies and do not affect runtime security
- **Workaround**: Run `npm audit fix` to address if needed, but verify tests still pass afterward

### Network-Dependent Features
- Integration tests make actual network calls to weather services (DWD, ZAMG, UWZ)
- Tests may show warnings about network failures in restricted environments
- This is expected behavior and does not indicate code issues

## Timing Expectations

**NEVER CANCEL any of these commands. All timing includes 50% safety buffer:**

- `npm install` -- 30 seconds timeout
- `npm run build` -- 30 seconds timeout  
- `npm run lint` -- 30 seconds timeout
- `npm run check` -- 30 seconds timeout
- `npm run test:package` -- 30 seconds timeout
- `npm run test:integration` -- 300 seconds timeout (5 minutes)
- `npm run translate` -- 30 seconds timeout

## Common Tasks Reference

### Repository Root Contents
```
README.md              -- Primary documentation (English)
README_DE.md          -- German documentation  
package.json          -- NPM configuration and scripts
io-package.json       -- ioBroker adapter metadata
tsconfig.json         -- TypeScript configuration
eslint.config.mjs     -- Linting configuration
src/                  -- TypeScript source code
build/                -- Compiled JavaScript (generated)
admin/                -- Admin UI files
test/                 -- Test files
img/                  -- Icons and images
.github/              -- GitHub Actions workflows
```

### Package.json Key Scripts
```json
{
  "build": "build-adapter ts",
  "test": "npm run test:ts && npm run test:package", 
  "test:ts": "mocha --config test/mocharc.custom.json src/**/*.test.ts",
  "test:package": "mocha test/package --exit",
  "test:integration": "mocha test/integration --exit", 
  "lint": "eslint -c eslint.config.mjs .",
  "check": "tsc --noEmit",
  "translate": "translate-adapter"
}
```

### Dependencies Summary
- **Runtime**: @iobroker/adapter-core, axios, jsonata
- **Build**: @iobroker/adapter-dev, typescript, rimraf
- **Testing**: @iobroker/testing (includes mocha, chai, sinon)
- **Code Quality**: @iobroker/eslint-config, prettier
- **Node.js**: Requires v20+ (specified in package.json engines)